# ๐ง ุญู ูุดููุฉ ุญุฐู ุงููุดุชุฑููู

## ๐จ **ุงููุดููุฉ:**

```
โ ุฎุทุฃ ูู ุญุฐู ุงููุดุชุฑู: update or delete on table "subscribers" violates foreign key constraint "sales_subscriber_id_fkey" on table "sales"
```

## ๐ **ุงูุณุจุจ:**

- **ูููุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช (Foreign Key Constraints)** ุชููุน ุญุฐู ุงููุดุชุฑู ุฅุฐุง ูุงู ูู ูุจูุนุงุช ูุฑุชุจุทุฉ
- ุงูููุฏ ุงูุญุงูู ูุถุจูุท ุนูู `RESTRICT` ุจุฏูุงู ูู `SET NULL`
- ุงููุทููุจ ุชุนุฏูู ุงููููุฏ ููุณูุงุญ ุจุญุฐู ุงููุดุชุฑููู ูุน ุงูุญูุงุธ ุนูู ุงูุจูุงูุงุช

---

## โ **ุงูุญู (ุฎุทูุชูู):**

### **ุงูุฎุทูุฉ 1: ุฅุตูุงุญ ูููุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช**

1. **ุงุฐูุจ ุฅูู Supabase Dashboard:**

   - [https://supabase.com](https://supabase.com)
   - ุงุฎุชุฑ ูุดุฑูุนู
   - ุงุฐูุจ ุฅูู **SQL Editor**

2. **ุชุดุบูู ุณูุฑูุจุช ุงูุฅุตูุงุญ:**

   ```sql
   -- ุงูุณุฎ ูุงูุตู ูุฐุง ูู SQL Editor

   -- ุฅุตูุงุญ ููุฏ ุงููุจูุนุงุช
   ALTER TABLE sales DROP CONSTRAINT IF EXISTS sales_subscriber_id_fkey;
   ALTER TABLE sales
   ADD CONSTRAINT sales_subscriber_id_fkey
   FOREIGN KEY (subscriber_id)
   REFERENCES subscribers(id)
   ON DELETE SET NULL;

   -- ุฅุตูุงุญ ููุฏ ุงููุฌููุนุงุช
   ALTER TABLE groups DROP CONSTRAINT IF EXISTS groups_subscriber_id_fkey;
   ALTER TABLE groups
   ADD CONSTRAINT groups_subscriber_id_fkey
   FOREIGN KEY (subscriber_id)
   REFERENCES subscribers(id)
   ON DELETE CASCADE;

   SELECT 'ุชู ุฅุตูุงุญ ุงููููุฏ ุจูุฌุงุญ!' AS status;
   ```

   **ุฃู ุงุณุชุฎุฏู ุงูููู ุงููุงูู:**

   - ุงูุณุฎ ูุญุชูู `fix-database-constraints.sql`
   - ุงูุตู ูู SQL Editor
   - ุงุถุบุท **Run**

### **ุงูุฎุทูุฉ 2: ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู**

```bash
# ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู ูุชุทุจูู ุงูุชุญุฏูุซุงุช ุงูุฌุฏูุฏุฉ
npm run dev
```

---

## ๐ฏ **ูุง ุชู ุฅุตูุงุญู ูู ุงูุชุทุจูู:**

### **1. ูุนุงูุฌุฉ ุฐููุฉ ููุญุฐู:**

- **ูุญุต ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ** ูุจู ุงูุญุฐู
- **ูุตู ุงููุจูุนุงุช** ุนู ุงููุดุชุฑู ุจุฏูุงู ูู ุญุฐููุง
- **ุญุฐู ุงููุฌููุนุงุช** (ุชูุงุฑูู ูุฃูุธูุฉ ุบุฐุงุฆูุฉ) ุงููุฑุชุจุทุฉ
- **ุฑุณุงุฆู ูุงุถุญุฉ** ูููุณุชุฎุฏู

### **2. ูุงุฌูุฉ ูุญุณูุฉ:**

- **ุชุญุฐูุฑ ูุณุจู** ูุธูุฑ ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ
- **ูุนูููุงุช ุชูุตูููุฉ** ุนู ุงููุจูุนุงุช ูุงููุฌููุนุงุช
- **ุชุฃููุฏ ูุงุถุญ** ูุจู ุงูุญุฐู
- **ูุคุดุฑ ุชุญููู** ุฃุซูุงุก ุนูููุฉ ุงูุญุฐู

### **3. ุฃูุงู ุฅุถุงูู:**

- **ูุญุต ุงูุนูุงูุงุช** ูุจู ุงูุญุฐู
- **ุชูุธูู ุงูุจูุงูุงุช** ุจุงูุชุฑุชูุจ ุงูุตุญูุญ
- **ุงุณุชุฑุฌุงุน ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ**

---

## ๐ **ุณููู ุงูุญุฐู ุงูุฌุฏูุฏ:**

### **ุฅุฐุง ูุงู ูููุดุชุฑู ูุจูุนุงุช:**

```
โ๏ธ ุชุญุฐูุฑ: ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ
โข ููุฌุฏ 3 ูุงุชูุฑุฉ ูุจูุนุงุช ูุฑุชุจุทุฉ - ุณูุชู ูุตููุง ุนู ุงููุดุชุฑู
โข ููุฌุฏ 2 ูุฌููุนุฉ ุชูุงุฑูู/ูุธุงู ุบุฐุงุฆู - ุณูุชู ุญุฐููุง
```

**ูุง ูุญุฏุซ:**

1. ุงููุจูุนุงุช ุชุจูู ููุฌูุฏุฉ ููู `subscriber_id` ูุตุจุญ `null`
2. ุงููุฌููุนุงุช (ุชูุงุฑูู ูุฃูุธูุฉ ุบุฐุงุฆูุฉ) ุชูุญุฐู
3. ุงููุดุชุฑู ููุญุฐู

### **ุฅุฐุง ูู ููู ูููุดุชุฑู ูุจูุนุงุช:**

```
โ ูุง ุชูุฌุฏ ุจูุงูุงุช ูุฑุชุจุทุฉ - ูููู ุงูุญุฐู ุจุฃูุงู
```

**ูุง ูุญุฏุซ:**

1. ุงููุฌููุนุงุช ุชูุญุฐู (ุฅู ูุฌุฏุช)
2. ุงููุดุชุฑู ููุญุฐู

---

## ๐งช **ุงุฎุชุจุงุฑ ุงูุญู:**

### **1. ุญุฐู ูุดุชุฑู ุจุฏูู ูุจูุนุงุช:**

1. ุฃุถู ูุดุชุฑู ุฌุฏูุฏ
2. ุงุญุฐูู ูุจุงุดุฑุฉ
3. ูุฌุจ ุฃู ููุญุฐู ุจุฏูู ูุดุงูู โ

### **2. ุญุฐู ูุดุชุฑู ูู ูุจูุนุงุช:**

1. ุฃุถู ูุดุชุฑู
2. ุฃูุดุฆ ูู ูุงุชูุฑุฉ ูุจูุนุงุช
3. ุงุญุฐู ุงููุดุชุฑู
4. ูุฌุจ ุฃู ุชุธูุฑ ุฑุณุงูุฉ ุงูุชุญุฐูุฑ โ
5. ุจุนุฏ ุงูุชุฃููุฏุ ููุญุฐู ุงููุดุชุฑู ูุชุจูู ุงููุงุชูุฑุฉ โ

### **3. ูุญุต ูุงุนุฏุฉ ุงูุจูุงูุงุช:**

```sql
-- ูุญุต ุงููุจูุนุงุช ุจุนุฏ ุญุฐู ูุดุชุฑู
SELECT
    id,
    customer_name,
    subscriber_id,  -- ูุฌุจ ุฃู ูููู null
    total_amount
FROM sales
WHERE customer_name IS NULL;

-- ูุญุต ุงููุดุชุฑููู
SELECT COUNT(*) FROM subscribers;
```

---

## ๐จ **ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ:**

### **1. ุชุญูู ูู ุงููููุฏ:**

```sql
-- ุนุฑุถ ุฌููุน ุงููููุฏ ุงูุญุงููุฉ
SELECT
    tc.table_name,
    tc.constraint_name,
    tc.constraint_type,
    rc.delete_rule
FROM information_schema.table_constraints AS tc
LEFT JOIN information_schema.referential_constraints AS rc
    ON tc.constraint_name = rc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
    AND tc.table_schema = 'public'
    AND tc.table_name IN ('sales', 'groups', 'group_items', 'sale_items')
ORDER BY tc.table_name;
```

### **2. ุฅุนุงุฏุฉ ุฅูุดุงุก ุงููููุฏ ูุฏููุงู:**

```sql
-- ุญุฐู ุฌููุน ุงููููุฏ ุงููุดููุฉ
ALTER TABLE sales DROP CONSTRAINT IF EXISTS sales_subscriber_id_fkey;
ALTER TABLE groups DROP CONSTRAINT IF EXISTS groups_subscriber_id_fkey;

-- ุฅุนุงุฏุฉ ุฅูุดุงุคูุง ุจุงูุดูู ุงูุตุญูุญ
ALTER TABLE sales
ADD CONSTRAINT sales_subscriber_id_fkey
FOREIGN KEY (subscriber_id) REFERENCES subscribers(id) ON DELETE SET NULL;

ALTER TABLE groups
ADD CONSTRAINT groups_subscriber_id_fkey
FOREIGN KEY (subscriber_id) REFERENCES subscribers(id) ON DELETE CASCADE;
```

### **3. ูู ุญุงูุฉ ุงูุทูุงุฑุฆ - ุญุฐู ูุฏูู:**

```sql
-- ุญุฐู ุงููุจูุนุงุช ุงููุฑุชุจุทุฉ ุฃููุงู (ุฅุฐุง ูุฒู ุงูุฃูุฑ)
UPDATE sales SET subscriber_id = NULL WHERE subscriber_id = 'SUBSCRIBER_ID_HERE';

-- ุซู ุญุฐู ุงููุดุชุฑู
DELETE FROM subscribers WHERE id = 'SUBSCRIBER_ID_HERE';
```

---

## โ **ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:**

ุจุนุฏ ุชุทุจูู ุงูุญู:

- โ **ุญุฐู ุขูู ูููุดุชุฑููู** ูุน ุฃู ุจุฏูู ูุจูุนุงุช
- โ **ุญูุธ ุจูุงูุงุช ุงููุจูุนุงุช** (ูุน ูุตููุง ุนู ุงููุดุชุฑู)
- โ **ุชุญุฐูุฑุงุช ูุงุถุญุฉ** ูููุณุชุฎุฏู
- โ **ูุงุฌูุฉ ูุญุณูุฉ** ูุน ูุนูููุงุช ููุตูุฉ
- โ **ูุง ูุฒูุฏ ูู ุฃุฎุทุงุก ุงููููุฏ**

**๐ ุงููุดููุฉ ูุญูููุฉ ุจุงููุงูู!**
